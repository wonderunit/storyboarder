THREE.JDLoader=function(e){this.manager=void 0!==e?e:THREE.DefaultLoadingManager},THREE.JDLoader.prototype={constructor:THREE.JDLoader,load:function(e,t,n,r){var s=this,a=this.texturePath&&"string"==typeof this.texturePath?this.texturePath:THREE.LoaderUtils.extractUrlBase(e);new THREE.FileLoader(this.manager).load(e,function(e){s.loadText(e,t,a)},n,r)},loadText:function(e,t,n){var r=JSON.parse(e);r&&t(this.parse(r,n))},setTexturePath:function(e){this.texturePath=e},parse:function(e,t){function n(e){if(e&&e.skin&&e.skin.skinBones.length&&e.skin.skinWeights.length)return m;var t=[];t.push(m[0]);var n=m[e.node],r={};return r.name=n.name,r.parent=0,r.pos=[n.pos[0],n.pos[1],n.pos[2]],r.scl=[n.scl[0],n.scl[1],n.scl[2]],r.rotq=[n.rotq[0],n.rotq[1],n.rotq[2],n.rotq[3]],t.push(r),t}function r(e){var t=new THREE.Matrix4;if(!m||e<0||!m[e])return t;for(var n=e;n>=0;n=m[n].parent){var r=m[n],s=new THREE.Vector3(r.pos[0],r.pos[1],r.pos[2]),a=new THREE.Vector3(r.scl[0],r.scl[1],r.scl[2]),i=new THREE.Quaternion(r.rotq[0],r.rotq[1],r.rotq[2],r.rotq[3]),o=(new THREE.Matrix4).compose(s,i,a);t.premultiply(o)}return t}function s(t){var n=-1;if(!t||!e.materials)return 0;for(var r=0;r<t.length;++r){var s=e.materials[t[r].materialIndex];if(s&&s.maps)for(var a=0;a<s.maps.length;++a)if("diffuse"==s.maps[a].type)if(n<0)n=s.maps[a].uvsIndex;else if(n!=s.maps[a].uvsIndex)return n}return n<0?0:n}function a(e,t){if(!e)return console.error("parseOffsetAnimation: no animation"),null;var n=e.fps||30,r=!0,s=e.length||-1;"frames"==e.timeline&&(r=!1,s/=n);var a=[],o=e.name||"default",l=(e.animNodes||[])[t];if(!l)return console.error("parseOffsetAnimation: animNode "+t+" is null !"),null;var u="";void 0!==l.nodeName?u=l.nodeName:void 0!==l.nodeIndex&&(u=m[l.nodeIndex].name);var p=i(e,t),c=p.sclTrackObject,h=p.posTrackObject,E=p.rotTrackObject;return f(r,n,THREE.VectorKeyframeTrack,u+".position",h,a),f(r,n,THREE.VectorKeyframeTrack,u+".scale",c,a),f(r,n,THREE.QuaternionKeyframeTrack,u+".quaternion",E,a),0===a.length?(console.error("parseOffsetAnimation: tracks.length is 0 !"),null):new THREE.AnimationClip(o,s,a)}function i(e,t){for(var n={times:[],values:[]},s={times:[],values:[]},a={times:[],values:[]},i=[],l=t;l>=0;l=m[l].parent){var p=e.animNodes[l];i=u(i=u(i=u(i,p.scl.times),p.rot.times),p.pos.times)}n.times=n.times.concat(i),s.times=s.times.concat(i),a.times=a.times.concat(i);var f=new THREE.Vector3,c=new THREE.Vector3,h=new THREE.Quaternion,E=new THREE.Matrix4,v=new THREE.Matrix4;v.getInverse(r(t));for(var d=0;d<i.length;++d)(E=o(e,t,i[d])).multiply(v),E.decompose(f,h,c),n.values.push(c.x),n.values.push(c.y),n.values.push(c.z),a.values.push(f.x),a.values.push(f.y),a.values.push(f.z),s.values.push(h.x),s.values.push(h.y),s.values.push(h.z),s.values.push(h.w);return{sclTrackObject:n,posTrackObject:a,rotTrackObject:s}}function o(e,t,n){var r=new THREE.Matrix4;if(!m||t<0||!e.animNodes[t])return r;for(var s,a,i,o,u,p,f,c,h,E,v=t;v>=0;v=m[v].parent){var d=e.animNodes[v];(a=(s=l(d.scl.times,n)).iBegin)==(i=s.iEnd)?u=new THREE.Vector3(d.scl.values[3*a],d.scl.values[3*a+1],d.scl.values[3*a+2]):(E=(n-d.scl.times[a])/(d.scl.times[i]-d.scl.times[a]),u=new THREE.Vector3(d.scl.values[3*a],d.scl.values[3*a+1],d.scl.values[3*a+2]),c=new THREE.Vector3(d.scl.values[3*i],d.scl.values[3*i+1],d.scl.values[3*i+2]),u=u.lerp(c,E)),(a=(s=l(d.pos.times,n)).iBegin)==(i=s.iEnd)?o=new THREE.Vector3(d.pos.values[3*a],d.pos.values[3*a+1],d.pos.values[3*a+2]):(E=(n-d.pos.times[a])/(d.pos.times[i]-d.pos.times[a]),o=new THREE.Vector3(d.pos.values[3*a],d.pos.values[3*a+1],d.pos.values[3*a+2]),f=new THREE.Vector3(d.pos.values[3*i],d.pos.values[3*i+1],d.pos.values[3*i+2]),o=o.lerp(f,E)),(a=(s=l(d.rot.times,n)).iBegin)==(i=s.iEnd)?p=new THREE.Quaternion(d.rot.values[4*a],d.rot.values[4*a+1],d.rot.values[4*a+2],d.rot.values[4*a+3]):(E=(n-d.rot.times[a])/(d.rot.times[i]-d.rot.times[a]),p=new THREE.Quaternion(d.rot.values[4*a],d.rot.values[4*a+1],d.rot.values[4*a+2],d.rot.values[4*a+3]),h=new THREE.Quaternion(d.rot.values[4*i],d.rot.values[4*i+1],d.rot.values[4*i+2],d.rot.values[4*i+3]),p=p.slerp(h,E));var g=(new THREE.Matrix4).compose(o,p,u);r.premultiply(g)}return r}function l(e,t){for(var n=0,r=0,s=0;s<e.length;++s){if(e[s]==t){n=r=s;break}if(e[s]>t){n=r=s;break}if(s==e.length-1){n=r=s;break}if(t<e[s+1]){n=s,r=s+1;break}}return{iBegin:n,iEnd:r}}function u(e,t){for(var n=[],r=0,s=0;r<e.length&&s<t.length;)e[r]<t[s]?(0!=n.length&&e[r]==n[n.length-1]||n.push(e[r]),++r):e[r]>t[s]?(0!=n.length&&t[s]==n[n.length-1]||n.push(t[s]),++s):(0!=n.length&&n[n.length-1]==e[r]||n.push(e[r]),++r,++s);for(;r<e.length;)0!=n.length&&e[r]==n[n.length-1]||n.push(e[r]),++r;for(;s<t.length;)0!=n.length&&t[s]==n[n.length-1]||n.push(t[s]),++s;return n}function p(e){if(!e)return console.error("parseKeyFrameAnimation: no animation"),null;var t=e.fps||30,n=!0,r=e.length||-1;"frames"==e.timeline&&(n=!1,r/=t);for(var s=[],a=e.name||"default",i=e.animNodes||[],o=0;o<i.length;o++){var l=i[o];if(l){var u="";void 0!==l.nodeName?u=l.nodeName:void 0!==l.nodeIndex&&(u=m[l.nodeIndex].name);var p=u;f(n,t,THREE.VectorKeyframeTrack,p+".position",l.pos,s),f(n,t,THREE.VectorKeyframeTrack,p+".scale",l.scl,s),f(n,t,THREE.QuaternionKeyframeTrack,p+".quaternion",l.rot,s)}}return 0===s.length?null:new THREE.AnimationClip(a,r,s)}function f(e,t,n,r,s,a){if(s&&Array.isArray(s.times)&&Array.isArray(s.values)){var i=[],o=[];if(i=i.concat(s.times),o=o.concat(s.values),!e)for(var l=0;l<i.length;++l)i[l]/=t;i&&0!=i.length&&o&&0!=o.length&&a.push(new n(r,i,o))}}var c=0,h=this,E=[],m=[],v=[],d=[],g=[],T=[],R=[];for(function(){if(E=[],void 0!==e.materials&&0!==e.materials.length){var n,r,s,a,i,o,l,u,p,f=0;for(f=0;f<e.materials.length;++f){var c=e.materials[f];if(r=new THREE.Color(16777215),s=new THREE.Color(1644825),c.diffuse&&r.fromArray(c.diffuse),c.specular&&s.fromArray(c.specular),a=void 0!==c.glossiness?c.glossiness:40,i=void 0,o=void 0,l=void 0,u=void 0,p=void 0,c.maps)for(var m=0;m<c.maps.length;++m)if(""!=c.maps[m].file)if("diffuse"==c.maps[m].type)(v=new THREE.TextureLoader).setCrossOrigin(h.crossOrigin),(i=v.load(t+c.maps[m].file)).wrapS=i.wrapT=THREE.RepeatWrapping;else if("specular"==c.maps[m].type)(v=new THREE.TextureLoader).setCrossOrigin(h.crossOrigin),(o=v.load(t+c.maps[m].file)).wrapS=o.wrapT=THREE.RepeatWrapping;else if("bump"==c.maps[m].type)(v=new THREE.TextureLoader).setCrossOrigin(h.crossOrigin),(l=v.load(t+c.maps[m].file)).wrapS=l.wrapT=THREE.RepeatWrapping;else if("normal"==c.maps[m].type)(v=new THREE.TextureLoader).setCrossOrigin(h.crossOrigin),(u=v.load(t+c.maps[m].file)).wrapS=u.wrapT=THREE.RepeatWrapping;else if("opacity"==c.maps[m].type){var v=new THREE.TextureLoader;v.setCrossOrigin(h.crossOrigin),(p=v.load(t+c.maps[m].file)).wrapS=p.wrapT=THREE.RepeatWrapping}n=new THREE.MeshPhongMaterial({name:name,color:r.getHex(),specular:s.getHex(),shininess:a,skinning:!0}),i&&(n.map=i),o&&(n.specularMap=o),l&&(n.bumpMap=l),u&&(n.normalMap=u),p&&(n.alphaMap=p,n.transparent=!0),void 0!==c.opacity&&(n.opacity=c.opacity,c.opacity<1&&(n.transparent=!0)),E.push(n)}}}(),function(){if(m=void 0!==e.hierarchy?e.hierarchy.nodes:e.nodes,Array.isArray(m)&&m.length>0)for(var t=0;t<m.length;++t)void 0!==m[t].rot&&(m[t].rotq=m[t].rot,m[t].rot=void 0);else m=[]}(),function(){var t=e.model;if(t){var a,i,o,l,u,p,f,c,h,E,R,w,H,y,k,x,b,A,S,V,B,M,O,W,I,C,q,N,F;if(t.splineShapes)for(W=0;W<t.splineShapes.length&&void 0!=(I=t.splineShapes[W]);++W)for(O=r(S=I.node),q=0;q<I.splines.length;++q){for((u=new THREE.BufferGeometry).name=I.name,I.splines.length>1&&(u.name+="_SubSpline"+q),F=new THREE.CurvePath,N=I.splines[q],a=0;a+2<N.points.length;a+=3)(w=new THREE.Vector3(N.points[a],N.points[a+1],N.points[a+2])).applyMatrix4(O),N.points[a]=w.x,N.points[a+1]=w.y,N.points[a+2]=w.z;for(a=0;a+11<N.points.length;a+=9)C=new THREE.CubicBezierCurve3(new THREE.Vector3(N.points[a],N.points[a+1],N.points[a+2]),new THREE.Vector3(N.points[a+3],N.points[a+4],N.points[a+5]),new THREE.Vector3(N.points[a+6],N.points[a+7],N.points[a+8]),new THREE.Vector3(N.points[a+9],N.points[a+10],N.points[a+11])),F.add(C);u.setFromPoints(F.getPoints(I.steps+1)),v.push(u),g.push("Line"),T.push(I),d.push(S)}if(t.meshes)for(var L=0;L<t.meshes.length;++L){if(u=new THREE.BufferGeometry,void 0==(f=t.meshes[L]))return;if(f.name&&(u.name=f.name),void 0==(h=f.verts))return;if(void 0==(R=f.vertElement))return;if(y=f.face,k=R.vertIndices,x=R.normals,R.colors,b=R.uvs,A=f.skin,void 0==(S=f.node)||!(S>=0&&S<m.length))return;if(!((V=m[S])&&V.pos&&V.rotq&&V.scl))return;if(void 0==y)return;if(B=y.vertElementIndices,M=y.groups,!B||!M)return;O=r(S),c=k.length;var j=new Float32Array(3*c);for(E=0;E<c;++E)a=3*k[E],i=3*E,(w=new THREE.Vector3(h[a],h[a+1],h[a+2])).applyMatrix4(O),j[i]=w.x,j[i+1]=w.y,j[i+2]=w.z;if(u.addAttribute("position",new THREE.BufferAttribute(j,3)),void 0!==x&&x.length>0){var z=(new THREE.Matrix3).getNormalMatrix(O),P=new Float32Array(x);for(a=0;a+2<x.length;a+=3)(H=new THREE.Vector3(x[a],x[a+1],x[a+2])).applyMatrix3(z).normalize(),P[a]=H.x,P[a+1]=H.y,P[a+2]=H.z;u.addAttribute("normal",new THREE.BufferAttribute(P,3))}if(void 0!==b&&b.length>0){a=(a=s(M))<b.length?a:0;var K=new Float32Array(b[a]);u.addAttribute("uv",new THREE.BufferAttribute(K,2)),b.length>1&&(a=0==a?1:0,K=new Float32Array(b[a]),u.addAttribute("uv2",new THREE.BufferAttribute(K,2)))}var Q=new Uint32Array(B);u.setIndex(new THREE.BufferAttribute(Q,1)),u.groups=M,l=h.length/3;var D,G,J=[],U=[];if(A&&A.skinBones&&A.skinWeights&&A.skinBones.length==A.skinWeights.length)for(E=0;E<l;++E){D=new THREE.Vector4(0,0,0,0),G=new THREE.Vector4(0,0,0,0);var _=0;for(o=0;o<4;++o)o<A.skinBones[E].length?(D.setComponent(o,A.skinBones[E][o]),G.setComponent(o,A.skinWeights[E][o]),++_):(D.setComponent(o,0),G.setComponent(o,0));for(;_<A.skinWeights[E].length;)G.addScalar(.25*A.skinWeights[E][_]),++_;J.push(D),U.push(G)}if(J.length>0&&U.length>0)for(p="SkinnedMesh",u.addAttribute("skinIndex",new THREE.Float32BufferAttribute(new Float32Array(4*c),4)),u.addAttribute("skinWeight",new THREE.Float32BufferAttribute(new Float32Array(4*c),4)),E=0;E<c;++E)D=J[a=k[E]],G=U[a],u.attributes.skinIndex.setXYZW(E,D.x,D.y,D.z,D.w),u.attributes.skinWeight.setXYZW(E,G.x,G.y,G.z,G.w);else p="Mesh";if("SkinnedMesh"==p){var X=n(f);X&&X.length>0&&(u.bones=X)}v.push(u),g.push(p),T.push(f),d.push(S)}}}(),function(){var t=e.animation;if(t&&t.keyframeAnimations&&0!=t.keyframeAnimations.length){var n,r,s,i=t.keyframeAnimations.concat(),o=[];for(r=0;r<i.length;++r)(s=p(i[r]))&&o.push(s);if(o.length>0)for(n=0;n<v.length;++n){var l=!1;if(v[n]instanceof THREE.Geometry?l=v[n].skinIndices&&v[n].skinIndices.length>0&&v[n].skinWeights&&v[n].skinWeights.length>0:v[n]instanceof THREE.BufferGeometry&&(l=v[n].attributes.skinIndex&&v[n].attributes.skinIndex.count>0&&v[n].attributes.skinWeight&&v[n].attributes.skinWeight.count>0),l)v[n].animations=o;else for(v[n].animations=[],r=0;r<i.length;++r)(s=a(i[r],d[n]))&&v[n].animations.push(s)}}}(),c=0;c<v.length;++c)v[c].computeFaceNormals(),v[c].computeBoundingSphere(),R.push({geometry:v[c],type:g[c],jd_object:T[c]});var w=function(){var e,t,n=new THREE.Sphere,r=0,s=0,a=0,i=[],o=[],l=new THREE.Vector3(0,0,0),u=new THREE.Vector3(0,0,0);if(v&&v.length){for(e=0;e<v.length;++e)v[e].boundingSphere||v[e].computeBoundingSphere(),s+=v[e].boundingSphere.radius;if(s>0){for(e=0;e<v.length;++e)t=v[e],o.push(t.boundingSphere.radius),i.push(t.boundingSphere.center),u.copy(t.boundingSphere.center),u.multiplyScalar(t.boundingSphere.radius/s),l.add(u);for(e=0;e<v.length;++e){var p=l.distanceTo(i[e]);p>=r&&(a=(r=p)+o[e])}n.center=l,n.radius=a}}return n}();return{objects:R,materials:E,jd_materials:e.materials,boundingSphere:w}}};